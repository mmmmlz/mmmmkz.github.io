<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Dynamic Knapsack Optimization Towards Efficient Multi-Channel Sequential Advertising | kerwin's notebook</title><meta name="author" content="mmmmlz"><meta name="copyright" content="mmmmlz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="今天介绍一篇阿里出品的广告序列投放算法 链接，这篇文章通过考虑用户在端上的长期价值，并且通过将序列投放问题建模为动态背包问题，最后给出了近似解。">
<meta property="og:type" content="article">
<meta property="og:title" content="Dynamic Knapsack Optimization Towards Efficient Multi-Channel Sequential Advertising">
<meta property="og:url" content="http://kerwinblog.top/2023/01/14/0112/index.html">
<meta property="og:site_name" content="kerwin&#39;s notebook">
<meta property="og:description" content="今天介绍一篇阿里出品的广告序列投放算法 链接，这篇文章通过考虑用户在端上的长期价值，并且通过将序列投放问题建模为动态背包问题，最后给出了近似解。">
<meta property="og:locale">
<meta property="og:image" content="http://kerwinblog.top/img/11.png">
<meta property="article:published_time" content="2023-01-14T11:42:22.000Z">
<meta property="article:modified_time" content="2023-05-06T14:03:36.293Z">
<meta property="article:author" content="mmmmlz">
<meta property="article:tag" content="Rec System">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://kerwinblog.top/img/11.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://kerwinblog.top/2023/01/14/0112/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Dynamic Knapsack Optimization Towards Efficient Multi-Channel Sequential Advertising',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 22:03:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/backgound.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="kerwin's notebook" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/11.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> home</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> Article</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/7.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="kerwin's notebook"><span class="site-name">kerwin's notebook</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> home</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> Article</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Dynamic Knapsack Optimization Towards Efficient Multi-Channel Sequential Advertising</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-01-14T11:42:22.000Z" title="Created 2023-01-14 19:42:22">2023-01-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-05-06T14:03:36.293Z" title="Updated 2023-05-06 22:03:36">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/paper-Reading/">paper Reading</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">4.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>14min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>今天介绍一篇阿里出品的广告序列投放算法 <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2006.16312">链接</a>，这篇文章通过考虑用户在端上的长期价值，并且通过将序列投放问题建模为动态背包问题，最后给出了近似解。<span id="more"></span>总得来说是比较有意思的解决问题的方式，但是我不太认为在线上环境能够取得很不错的效果，原因后面分析。</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>现在的电商平台中，通过在一定预算约束下去优化GMV，也就是提高广告主的ROI是广告主的核心诉求之一。现有的绝大多数出价策略将一段时间的GMV优化问题拆解为：对每次用户的请求进行独立优化，并且认为这些独立优化汇总结果可以等同于这一段时间的GMV最优化。事实上，这类策略得到解可能只是次优解，因为他们以孤立的视角把消费者和广告限定在了单次交互中，而忽略了一段时间内多次交互可能产生的其他影响。</p>
<p>上面一段话可能有点绕，作者在这里举了一个例子，首先，同一个消费者在一段时间内（比如3天）会多次访问淘宝，并且随机地在淘宝不同场景出现（例如首页、购后），这为同一个广告和同一个消费者在不同场景多次接触创造了机会；其次，大量的成交并非发生在消费者和广告的初次接触中，而是发生在第二次或者以后更多次的接触中，通过ab实验，作者发现广告和消费者的前序接触会影响消费者对该广告在后续接触中的点击率和转化率，说明多次的接触对消费的心智有积累影响的效应，在这样的背景下，单次请求优化结果的积累很容易导致次优解。</p>
<p>然而，基于长期价值的序列投放算法在解决预算约束下GMV的优化问题时存在诸多挑战：</p>
<ol>
<li>优化目标是长期的累积价值，而决策的粒度是单次的；如何基于长期价值的预估获得最优的单次决策？</li>
<li>长期价值预估模型的学习离不开策略探索生成的序列数据。长期价值预估模型和决策模型的学习如何保证收敛性？如何保证决策的最优性？如何提升探索策略的效率？</li>
<li>如何保障预算约束的满足？</li>
</ol>
<p>针对这些挑战，作者逐一给出了解决方案，首先，将预算约束问题建模为背包问题：背包中物品的价值为&lt;用户，ad&gt;形成的序列价值（长期成交、收藏加购等），物品的重量为此序列中发生的成本（消耗）；我们按照性价比（序列价值/成本）由高到低逐个选择物品，直到选出的物品总消耗刚好不超过预算约束。这里，由于物品的重量远远小于背包的容量，按性价比排序的贪心算法能够接近最优解。然而，每个序列的价值和成本与运营该序列的广告策略有关，因此这是一个动态背包问题，为求解此动态背包，作者采用了双层优化问题的迭代解法来求解：1）物品的贪心选择，2）物品价值/成本以及对应策略的优化。在此框架下，我们提出了一种理论最优的运营策略，该策略满足强化学习中的Policy lteration，能够保证其学习的收敛性。此外，为了使策略在实际场景中落地，，作者提出了一种将连续出价转换为离散动作的方法，能够在不丢失出价精度的情况下，大幅度减少动作的探索时间，提高学习效率。综上，作者将整个算法称之为MSBCB。</p>
<h1 id="建模方法"><a href="#建模方法" class="headerlink" title="建模方法"></a>建模方法</h1><p><strong>问题定义：</strong>对于某个广告，我们需要在一定的预算约束$B$下优化一段时间窗口内的成交金额，这个过程可以被建模为一个背包问题：我们把预算约束当做背包的总空间，把用户与广告的每次接触当做一个物品，在$t$时刻，物品的价值定义为$u<em>t$为用户购买期望，物品的重量定义$c_t$为接触带来的消耗期望；假设总共有$U$个用户${j=1,2,3….,U}$，我们对某个用户$j$的竞价策略为$\pi_j$，则此广告对该用户未来累积成交价值为$V_G(j|\pi_j)=\mathbb E|\sum</em>{t=0} u<em>t|\pi_j|$，未来累积消耗为$V_C(j|\pi_j)=\mathbb E|\sum</em>{t=0} c_t|\pi_j|$；那么，此背包问题被形式化建模为：</p>
<script type="math/tex; mode=display">
\max\limits_{\mathcal X,\varPi}\sum^U_{j=1}x_jV_c(j|\pi_j)\\
s.t. \sum_{j=1}^U{x_j}V_G(j|\pi_j)\le B</script><p>其中，$\varPi={\pi_1,\pi_2,…,\pi_U}$，$\mathcal X ={x_1,x_2,…x_U}$，而且</p>
<script type="math/tex; mode=display">
x_j =\begin{cases}
1 &\text{if user} j   \text{ is selected for advertising}\\
0 &\text{otherwise}
\end{cases}</script><p><strong>求解思路：</strong>我们的目标是需要找到最优的竞价策略$\varPi^<em>={\pi_1^</em>,\pi_2^<em>…\pi_U^</em>}$和用户的挑选策略$\mathcal X^<em> ={x_1^</em>,x_2^<em>,…x_U^</em>}$来最大化目标函数。但是，此背包问题是一个双层优化问题(bilevel optimization problem)，因为对$\varPi$的优化是内嵌在对$\mathcal X$的优化中，也就是说，我们要先选定对那些用户进行优化，然后才是如何优化这些用户的策略。当然，用户策略的变化也会对用户的选择产生影响，因为不同的投放策略会导致同一个用户的未来长期价值不同个，相当于各个物品的价值和重量会发生变化，因此影响着最后装进背包的物品，综上，此背包是一个动态背包，各个物品的价值和重量都是动态变化的，$\varPi$会影响物品的价值和重量，而$\mathcal X$影响着最后装入背包的物品，$\mathcal X$和$\varPi$互相影响着。对于此问题，既然同时优化两个变量比较困难，那么我们就固定一个变量在优化另一个变量，采用迭代的方式求解两个变量，因此，问题被拆解为两部分。</p>
<h2 id="固定-varPi-优化-mathcal-X"><a href="#固定-varPi-优化-mathcal-X" class="headerlink" title="固定$\varPi$,优化$\mathcal X$"></a>固定$\varPi$,优化$\mathcal X$</h2><p>给定每个用户策略 $\varPi$ ，然后预估每个用户未来价值（成交、消耗），然后通过“贪心方式”逐个选出高性价比（ROI）用户，直到广告满足广告主预算。定义用户性价比CPR(Cost-Performance Ratio)，选用户的过程：</p>
<p><img src="/2023/01/14/0112/image-20230502191418479.png" alt="image-20230502191418479" style="zoom:67%;"></p>
<p>其中，$\text{CPR}<em>{thr}$是一个阈值，$\text{CPR}_j=$  <strong>未来累计成交价值 / 未来累计消耗；</strong>通过贪心方式把用户按照性价比从高到低排序，然后筛选大于阈值的所有用户：$\CPR_j \ge \CPR</em>{thr}$ 。值得注意的是，由于用户粒度的消耗相对于广告主的预算是忽略不计的（各个物品的重量相对背包的重量是非常小的）。因此在这个背包问题中，此贪心框架是基本上逼近最优解的。</p>
<h2 id="固定-mathcal-X-优化-varPi"><a href="#固定-mathcal-X-优化-varPi" class="headerlink" title="固定$\mathcal X$,优化$\varPi$"></a>固定$\mathcal X$,优化$\varPi$</h2><p>当知道哪些用户被装进背包后，进一步优化各个<strong>用户策略</strong> $\pi_j$ 使其对商品的未来累计成交价值最多，同时尽可能减小消耗（使物品价值变大且重量变小）。提出了策略的最优方案：</p>
<script type="math/tex; mode=display">
\pi_j^*=argmax_{\pi_j}[V_G(j|\pi_j)-CPR_{thr}*V_c(j|\pi_j)]</script><p>可以通过反证法来证明此方案的合理性：</p>
<p>证：假设此方案非最优，那么至少存在一个更好的用户策略$\pi^{‘’}$能使$\Delta V<em>G(j)/ \Delta V_C(j) \gt CPR</em>{thr}$;则存在以下变换：$\frac{\Delta V<em>G(j)}{\Delta V_C(j)} \gt CPR</em>{thr} \Leftrightarrow \frac{V<em>C(j|\pi^{‘’})-V_C(j|\pi^<em>)}{V_G(j|\pi^{‘’})-V_G(j|\pi^</em>)} \gt CPR</em>{thr} \Leftrightarrow [V<em>G(j|\pi^{‘’}_j)-CPR</em>{thr}<em>V_c(j|\pi^{‘’}_j)] \gt [V_G(j|\pi^</em><em>j)-CPR</em>{thr}<em>V_c(j|\pi^</em><em>j)]$，最后一个等式说明策略$\pi_j^*$不满足最优方案的公式，说明不能找到一个$\pi^{‘’}$使得$\frac{\Delta V_G(j)}{\Delta V_C(j)} \gt CPR</em>{thr}$。</p>
<p>同时，选择此方案有如下优势：</p>
<ol>
<li>将广告优化目标由除法变成减法：论文中将奖励定义为ROI：$reward = V_G(\pi)/V_C(\pi)$，由于ROI相加没有意义，变成减法 $reward = V_G(\pi)-\lambda V_C(\pi)$后，奖励就是线性可加的，能够通过强化学习求解；</li>
<li>当证明$\lambda = CPR_{thr}$时，用强化学习优化reward能够保证当前动态背包问题的最优性质。</li>
</ol>
<p><strong>迭代求解：</strong></p>
<p>一旦确定动态背包中阈值$CPR<em>{thr}$ ，可以根据后续方案求得用户最优的竞价策略 $\pi_j^*$ ; 但是实际应用中，因为一开始无法知道广告主的预算阈值的准确值$CPR</em>{thr}^*$ 。因此需要预设$CPR<em>{thr}$ 来优化竞价策略，然后基于当前的策略和真实反馈进一步更新阈值$CPR</em>{thr}$，过程如下:</p>
<ul>
<li>固定 $\mathcal X$ ，优化$\varPi$ ：给定一个 $CPR_{thr}$ ，优化得到一个最优竞价策略$\varPi^<em> ={\pi_1^</em>…\pi_U^*} $</li>
<li>固定 $\varPi$ ，优化$\mathcal X$ ：根据 $CPR<em>{thr}$和用户$\pi_j$ , 贪心求解动态背包问题，然后通过真实反馈消耗更新 $CPR</em>{thr}$</li>
</ul>
<h1 id="方案细节"><a href="#方案细节" class="headerlink" title="方案细节"></a>方案细节</h1><h2 id="固定-mathcal-X-优化-varPi-——强化学习求解"><a href="#固定-mathcal-X-优化-varPi-——强化学习求解" class="headerlink" title="固定$\mathcal X$,优化$\varPi$ ——强化学习求解"></a>固定$\mathcal X$,优化$\varPi$ ——强化学习求解</h2><p>给定阈值 $CPR_{thr}^<em>$，优化用户每次广告触达上的出价策略，应用强化学习解决这个优化未来长期价值的reward问题。对用户状态干预的抓手（动作）主要是出价 / 调价，提出一种基于DQN的“<em>*动作约减</em></em>”(action space reduction)方法，能够在不损失出价精度情况下将连续的动作离线到0/1空间，不需要人为调参。</p>
<p><strong>动作约减</strong>：对一个广告动作定义投放（$\hat{a}_t = 1$ ）和不投放（$\hat{a}_t = 0$ ）两种，可以直接使用DQN类算法进行求解；但是需要解决以下两个问题：1）如何将长期价值预估转化为投/不投动作策略；2）投和不投动作对应的出价分别是多少才不会损失出价精度？</p>
<p>针对问题1），需要分析长期价值的预估值与动作策略的映射关系，2.2章节中单步奖励被定义为减法 $reward = V<em>G(\pi)-\lambda V_C(\pi)$ 后，根据马尔可夫决策过程，对每个动作的Q值进行定义： $Q(s,\hat{a}_t) = Q_G(s,\hat{a}) -CPR^*</em>{thr}*Q_C(s,\hat{a}_t)$ ,其中 $Q_G(s,\hat{a}_t)$表示此动作下未来ed成交期望， $Q_C(s,\hat{a}_t)$表示此动作下未来的消耗期望。那么，动作策略可表示为：</p>
<script type="math/tex; mode=display">
\hat{a}_t^* =\begin{cases}1 &\text{if} \ Q (s,\hat{a}_t=1)\gt Q(s,\hat{a}_t=0) \\0 &\text{otherwise}\end{cases}</script><p>基于两个动作的Q值，能够对动作进行决策；推导广告出价的准确值：对于 $\hat{a}_t=0 $，定义出价$\hat{b}_t=0 $ ,保证此广告在竞价中不会最终展现；对于 $\hat{a}_t=1 $ ，作出以下推导：</p>
<script type="math/tex; mode=display">
Q(s,\hat{a}_t=1) \gt Q(s,\hat{a}_t=0) 
\\\Leftrightarrow Q_G(s,\hat{a}_t=1)-CPR_{thr}^**Q_C(s,\hat{a}_t=1) \gt \\
    Q_G(s,\hat{a}_t=0)-CPR_{thr}^**Q_C(s,\hat{a}_t=0) \\
    \Leftrightarrow Q_G(s,\hat{a}_t=1)-CPR_{thr}^**(\text{bid}_t^{2nd}*CTR+Q_C^{next}(s,\hat{a}_t=1) \gt \\ Q_G(s,\hat{a}_t=0)-CPR_{thr}^**(0+Q_C^{next}(s,\hat{a}_t=0) \\
    \Leftrightarrow  \mathbf {bid}_t^{2nd} \lt(\frac{Q_G(s,\hat{a}_t=1)}{CPR_{thr}^* * CTR} - \frac{Q_C^{next}(s,\hat{a}_t=1)}{CTR})\\ -(\frac{Q_G(s,\hat{a}_t=0)}{CPR_{thr}^* * CTR} - \frac{Q_C^{next}(s,\hat{a}_t=0)}{CTR})</script><p>其中，$Q<em>C^{next}(s,\hat{a}_t)$ 是下一时刻动作 $\hat{a}_t$ 未来累计消耗的Q值；将最后一个式子中右边部分设为$b_t^*$ ,并且把 $b</em>{t}^*$ 作为 $\hat{a}_t=1$ 时的最优出价。</p>
<p>综上，将连续的动作空间 $(a<em>t \in [0,bid</em>{max}])$约减到一个二维空间  ，策略上无论是 $\hat{a}<em>t=1$   还是 $\hat{a}_t=0$ ，都可以用  $\hat{a}_t=b_t^*$ 来作为最终出价。因此，只需要预估4个长期价值，然后算出最终出价 $b</em>{t}^*$ 并参与竞价；这四个长期价值分别反应着广告在两个动作下t时刻未来的成交期望，和t+1时刻未来的期望，可以通过bootstrap方式学习，也可以通过MC的方式学习。</p>
<h2 id="固定-varPi-，优化-mathcal-X-——背包求解"><a href="#固定-varPi-，优化-mathcal-X-——背包求解" class="headerlink" title="固定 $\varPi$，优化$ \mathcal X$——背包求解"></a>固定 $\varPi$，优化$ \mathcal X$——背包求解</h2><p>在给定策略$\varPi = {\pi<em>1^<em>,…,\pi_U^</em>}$后，需要优化背包中的物品，根据2.1节需要对每个用户进行性价比排序，然后贪心取性价比高的用户进行投放，直到最后一个用户满足 $CPR_j \ge CPR</em>{thr}$ ，一个用户根据投和不投策略会存在两个CPR值，取最大即可：</p>
<script type="math/tex; mode=display">
CPR_J = \max_{\hat{a}_t \in (0,1)}CPR_j(\hat{a}_t)</script><p>其中，每个动作的CPR值都可以被以下式子计算：</p>
<script type="math/tex; mode=display">
CPR_j (\hat{a_t}) = \begin{cases}\frac{Q_G(s,\hat{a}_t)}{\mathbf{bid_t^{2nd}*CTR+Q_C^{next}(s,\hat{a}_t=1)}} &\text{if} \ \hat{a_t}=1   \\
\frac{Q_G(s,\hat{a_t}=1)}{0+Q_C^{next}(s,\hat{a}_t=0)} &   \text{if} \ \hat{a_t}=0 \end{cases}</script><p>值得注意，上面所有的计算公式除了二价$bid_t^{2nd}$ 外，CPR计算只依赖：$Q_G(s,\hat{a}_t=1)$ 、$Q_C^{next}(s,\hat{a}_t=1)$  、 $Q_G(s,\hat{a}_t=0)$  和 $Q_C^{next}(s,\hat{a}_t=1)$ 四个长期价值，由于在决策前无法确定二价，因此将二价替换为最优出价$b_t^*$ ,效果和最优性质不变。</p>
<p>在通过真实反馈消耗更新初始$CPR_{thr}$时，设计一个PID控制器基于实际消耗和预算之间的差距来更新，让实际消耗与预算持平。</p>
<h2 id="预估模型"><a href="#预估模型" class="headerlink" title="预估模型"></a>预估模型</h2><p><img src="/2023/01/14/0112/image-20230503142023163.png" alt="image-20230503142023163" style="zoom: 80%;"></p>
<p>模型的预估对象分成交和消耗两种，因此我们这是一个多任务学习，需要同时学习回归和分类。为应对多任务学习，我们将模型结构进行拆分，底层共享embedding，顶层网络参数解耦，以降低多任务学习互相不利干扰，而且通过validation的方式优化各个loss之间的权重。其次，对于回归任务，由于其存在大量的零样本，导致模型成为一个<strong>零膨胀模型（</strong>Zero-inflated models），其输出基本上全为0，无法用MSE loss来正常学习网络参数。为解决此问题，我们提出两种解决办法：</p>
<ol>
<li><strong>通过合理的负采样来保证证样本的有效学习</strong>，并通过校准技术补偿由样本分布调整造成的预估偏差；</li>
<li><strong>引入CTR先验，构造CTR loss来辅助回归学习</strong>。我们认为消耗的期望可以拆分成消耗发生的概率与对应的消耗值的点乘，因此我们将未来消耗发生的概率显示地单独用CTR的label来学习，并使其更新不受其他loss的影响；然后我们基于较为准确的消耗概率，再来学习其概率对应下的消耗值，能够有效避免消耗值输出全为0的情况，使MSE loss能正常更新模型参数。</li>
</ol>
<h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p><img src="/2023/01/14/0112/image-20230503142255287.png" alt="image-20230503142255287"></p>
<p>对整个流程进行梳理：</p>
<ol>
<li>首先，当用户请求到达广告平台之后，我们构造用户和广告特征，然后对每个进行四个长期价值的预估，得出每个广告所采取的策略（投/不投）并算出对应的最优出价。</li>
<li>接着，对于任意广告，我们计算当前用户在两个不同决策下的最高性价比，若此性价比高于此广告的阈值CPRthr，则将当前用户装入此广告的背包中。</li>
<li>最后，我们拿到用户的反馈，一方面，我们在PID模块中基于预算和实际消耗来更新阈值CPRthr，另一方面，我们构造训练数据来更新强化学习模型参数，使预估的长期价值更准确。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在这个实验中，阿里打破传统ocpc竞价模型的思路，通过强化学习模拟了整个竞价的过程，只能默默献上本人的膝盖了！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://kerwinblog.top">mmmmlz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://kerwinblog.top/2023/01/14/0112/">http://kerwinblog.top/2023/01/14/0112/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Rec-System/">Rec System</a></div><div class="post_share"><div class="social-share" data-image="/img/11.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/24/0224/" title="猜你想去？"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">猜你想去？</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/04/20221204/" title="A Survey of Multi-Domain model"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">A Survey of Multi-Domain model</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/03/20/20240320/" title="MetaSplit Meta-Split Network for Limited-Stock Product Recommendation"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-20</div><div class="title">MetaSplit Meta-Split Network for Limited-Stock Product Recommendation</div></div></a></div><div><a href="/2023/06/02/20230601/" title="When Search Meets Recommendation"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-02</div><div class="title">When Search Meets Recommendation</div></div></a></div><div><a href="/2023/05/03/0503/" title="Let’s think step by step"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-03</div><div class="title">Let’s think step by step</div></div></a></div><div><a href="/2023/03/19/0319/" title="Position bias"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-19</div><div class="title">Position bias</div></div></a></div><div><a href="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/" title="混排到底该怎么排？"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-03</div><div class="title">混排到底该怎么排？</div></div></a></div><div><a href="/2023/02/24/0224/" title="猜你想去？"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-24</div><div class="title">猜你想去？</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/11.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mmmmlz</div><div class="author-info__description">great ideas in CV&RS</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mmmmlz"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Focus on the latest developments in recommendation algorithms, advertising algorithms, large models, etc.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BB%BA%E6%A8%A1%E6%96%B9%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">建模方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A-varPi-%E4%BC%98%E5%8C%96-mathcal-X"><span class="toc-number">2.1.</span> <span class="toc-text">固定$\varPi$,优化$\mathcal X$</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A-mathcal-X-%E4%BC%98%E5%8C%96-varPi"><span class="toc-number">2.2.</span> <span class="toc-text">固定$\mathcal X$,优化$\varPi$</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E7%BB%86%E8%8A%82"><span class="toc-number">3.</span> <span class="toc-text">方案细节</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A-mathcal-X-%E4%BC%98%E5%8C%96-varPi-%E2%80%94%E2%80%94%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E6%B1%82%E8%A7%A3"><span class="toc-number">3.1.</span> <span class="toc-text">固定$\mathcal X$,优化$\varPi$ ——强化学习求解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A-varPi-%EF%BC%8C%E4%BC%98%E5%8C%96-mathcal-X-%E2%80%94%E2%80%94%E8%83%8C%E5%8C%85%E6%B1%82%E8%A7%A3"><span class="toc-number">3.2.</span> <span class="toc-text">固定 $\varPi$，优化$ \mathcal X$——背包求解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E4%BC%B0%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.3.</span> <span class="toc-text">预估模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">3.4.</span> <span class="toc-text">整体架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/20/20240320/" title="MetaSplit Meta-Split Network for Limited-Stock Product Recommendation">MetaSplit Meta-Split Network for Limited-Stock Product Recommendation</a><time datetime="2024-03-20T12:13:50.000Z" title="Created 2024-03-20 20:13:50">2024-03-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/06/02/20230601/" title="When Search Meets Recommendation">When Search Meets Recommendation</a><time datetime="2023-06-02T13:21:12.000Z" title="Created 2023-06-02 21:21:12">2023-06-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/25/0525/" title="他山之石————推荐系统中的跨域建模">他山之石————推荐系统中的跨域建模</a><time datetime="2023-05-25T11:01:41.000Z" title="Created 2023-05-25 19:01:41">2023-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/20/0520/" title="Optimizing Feature Set for Click-Through Rate Prediction">Optimizing Feature Set for Click-Through Rate Prediction</a><time datetime="2023-05-20T11:01:41.000Z" title="Created 2023-05-20 19:01:41">2023-05-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/12/rl-05/" title="强化学习笔记5————AC与PPO">强化学习笔记5————AC与PPO</a><time datetime="2023-05-12T13:00:18.000Z" title="Created 2023-05-12 21:00:18">2023-05-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/7.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By mmmmlz</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script></div></body></html>