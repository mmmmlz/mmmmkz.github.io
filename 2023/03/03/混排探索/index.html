<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>混排到底该怎么排？ | kerwin's notebook</title><meta name="author" content="mmmmlz"><meta name="copyright" content="mmmmlz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="混排，往往是的推荐系统的最后一个环节，在这个阶段，自然内容（后面简称item）需要与营销内容（后面简称 ad）进行混合，生成最终推送给用户的 list 如果以 Long Term Value(LTV)的视角来看,这是个在 LT 和 V 之间做 trade-off 的过程，ad 如果出得过多，必然会挤压 item 的数量和位置，进而影响用户体验和留存即 LT，但相应的广告收入，或者说 Av">
<meta property="og:type" content="article">
<meta property="og:title" content="混排到底该怎么排？">
<meta property="og:url" content="http://kerwinblog.top/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/index.html">
<meta property="og:site_name" content="kerwin&#39;s notebook">
<meta property="og:description" content="混排，往往是的推荐系统的最后一个环节，在这个阶段，自然内容（后面简称item）需要与营销内容（后面简称 ad）进行混合，生成最终推送给用户的 list 如果以 Long Term Value(LTV)的视角来看,这是个在 LT 和 V 之间做 trade-off 的过程，ad 如果出得过多，必然会挤压 item 的数量和位置，进而影响用户体验和留存即 LT，但相应的广告收入，或者说 Av">
<meta property="og:locale">
<meta property="og:image" content="http://kerwinblog.top/img/11.png">
<meta property="article:published_time" content="2023-03-03T13:56:49.000Z">
<meta property="article:modified_time" content="2023-05-06T14:03:36.377Z">
<meta property="article:author" content="mmmmlz">
<meta property="article:tag" content="Rec System">
<meta property="article:tag" content="广告">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://kerwinblog.top/img/11.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://kerwinblog.top/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '混排到底该怎么排？',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 22:03:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/backgound.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="kerwin's notebook" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/11.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> home</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> Article</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/7.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="kerwin's notebook"><span class="site-name">kerwin's notebook</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> home</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> Article</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">混排到底该怎么排？</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-03-03T13:56:49.000Z" title="Created 2023-03-03 21:56:49">2023-03-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-05-06T14:03:36.377Z" title="Updated 2023-05-06 22:03:36">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Notes/">Notes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">3.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>11min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>混排，往往是的推荐系统的最后一个环节，在这个阶段，自然内容（后面简称item）需要与营销内容（后面简称
ad）进行混合，生成最终推送给用户的 list</p>
<p>如果以 Long Term Value(LTV)的视角来看,这是个在 LT 和 V 之间做
trade-off 的过程，ad 如果出得过多，必然会挤压 item
的数量和位置，进而影响用户体验和留存即 LT，但相应的广告收入，或者说
Average revenue per user(<a target="_blank" rel="noopener" href="https://www.investopedia.com/terms/a/arpu.asp">ARPU</a>)
会提升，反之亦然。<span id="more"></span></p>
<p>所以业界往往的做法是定一个用户体验的约束，在这个约束下尽可能优化 ad
的效率，即达到收入最大化，因此很自然可以把这个建模成一个最优化问题，LinkedIn
在 2020 年的这篇 paper就是这么做的，<a target="_blank" rel="noopener" href="https://dl.acm.org/doi/pdf/10.1145/3394486.3403391">Ads Allocation
in Feed via Constrained Optimization</a></p>
<p>直观地看混排这个问题，有 2 个子问题需要解决 （1）怎么计算每个 item 或
ad 在每个位置上的价值：因为 item 和 ad
是各自排序的，目标不同，最终的值的量纲也不同，这么把两者的 scale
拉到可比范围是一个需要讨论的问题 （2）怎么分配能让最终 list
价值最大化：在 item 和 ad 的价值确认后，怎么插入 item 和 ad
的位置，从而达到整个 list 的最大化</p>
<p>上面提到的 LinkedIn 的 paper
重点是在解决第二个问题，部分内容也涉及到第一个问题 ；本文会先讲一下这篇
paper 的建模方法，然后讨论下计算 item 和 ad
价值的一些思路，混排中一些其他需要注意的事项</p>
<h2 id="建模方案">建模方案</h2>
<p>paper
把问题建模成如下图最优化问题（单次请求的最优，目前不考虑请求间的优化）</p>
<p><img src="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/Rerank_optimize.png"></p>
<p>各符号含义如下</p>
<ul>
<li><span class="math inline">\(i\)</span>: 一次请求中位置的 index</li>
<li><span class="math inline">\(x_i\)</span>: 是否在第 i
个位置插入ad</li>
<li><span class="math inline">\(j\)</span>: 请求的 index</li>
<li><span class="math inline">\(u^o_i\)</span>: item 在第 i 个位置的
engagement utility（可理解为内容本身的价值，item和ad都有）</li>
<li><span class="math inline">\(u^a_i\)</span>: ad 在第 i 个位置的
engagement utility</li>
<li><span class="math inline">\(r_i\)</span>: ad 在第 i 个位置的 revenue
utility（可理解为商业价值，item没有这个价值）</li>
<li><span class="math inline">\(C\)</span>: 全局 engagement utility
的一个门槛, 一种可能的方式是设置成可能最大的 engagement
utility（没有广告） 的一个百分比</li>
</ul>
<p>通过对偶拉格朗日可以求解出如下的解，式子中的 <span class="math inline">\(α\)</span>是上面第一个约束的拉格朗日乘数；这个变量的物理含义是一个
bid，paper 称其为 “shadow bid”，作用是把 engagement utility 的 scale
变换至 revenue utility 的 scale；则最终在位置 i 插入 ad 或 item
的价值如下图表 1 所示</p>
<p><img src="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/Rerank_solution.png" alt="img" style="zoom: 67%;"></p>
<p>上面的最优化问题的约束只是总体 list 的 engagement utility
要大于特定预制，但混排往往还有一些硬约束，在paper中提到的是：top slot 和
min gap
，分别表示第一个广告的位置约束，两个广告最小间隔的约束；除了这两个约束，一些常见的约束还有
showtime gap 约束（出现广告的评率）、ad load
约束等(广告出现比例的约束)</p>
<p><img src="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/image-20230423222916631.png"></p>
<p>这两个约束并没有直接体现在最优化的建模里，而是体现在最后的混排算法里，整个算法流程如下</p>
<p><img src="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/Rerank_algorithm.png" alt="img" style="zoom:50%;"></p>
<h2 id="建模关键问题讨论">建模关键问题讨论</h2>
<p>上面的建模虽然比较直观，但涉及到的一些需要解决的关键问题，</p>
<h3 id="shadow-bid-α-的计算">shadow bid <span class="math inline">\(α\)</span> 的计算</h3>
<p>paper 提到的 shadow bid，在经济学上称为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/影子价格">影子价格</a>，物理含义是表示的是增加一个单位的资源所带来的边际收益，关于影子价格更多讨论可参考
<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23510001">线性规划中的影子价格怎么理解？</a></p>
<p>这里的影子价格 <span class="math inline">\(α\)</span>是一个关于 <span class="math inline">\(C\)</span> 的函数，paper
提到获取这个值的三种方法，</p>
<p><img src="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/Rerank_shadowbid.png" alt="img" style="zoom:67%;"></p>
<p>从上图可知，基本思路是 （1）确定 <span class="math inline">\(C\)</span> 的值之后求解原问题，得到 <span class="math inline">\(α\)</span> （2）通过在线 ab 实验来确定这个参数
（3）离线回放（感觉这里跟第一个是重合的，因为求解原问题也是需要回放历史数据，只是用多长的历史数据，以及更新频率有多大）</p>
<h3 id="uo_iua_i-和-r_i的计算"><span class="math inline">\(u^o_i\)</span>、<span class="math inline">\(u^a_i\)</span> 和 <span class="math inline">\(r_i\)</span>的计算</h3>
<p>关于这几个值的获取，paper 并没有提供明确的方法，只是提到了
<strong><span class="math inline">\(u^a_i\)</span>、 <span class="math inline">\(u^o_i\)</span> and <span class="math inline">\(r_i\)</span> are drawn from the same distribution
as was the historical data</strong></p>
<p>但如果真的这么做，存在的问题必然是历史数据会很稀疏，容易出现新的 item
或 ad
没有数据，或者把统计历史数据的维度拉得更大，这样容易导致效果变差，数据没区分性；因此，最终还是需要往预估方向去做</p>
<p>如果考虑实际的业务，<span class="math inline">\(u^o_i\)</span> 和
<span class="math inline">\(r_i\)</span> 的值比较好获取，直接取原本 item
排序和 ad 排序中各自的分数即可，但 <span class="math inline">\(u^a_i\)</span> 的值应该如何获取？（其实这里的
<span class="math inline">\(u^o_i\)</span> 和 <span class="math inline">\(r_i\)</span>
的值的获取还有个问题，就是怎么获取一个 item 或 ad 在所有位置的 <span class="math inline">\(u\)</span> 或 <span class="math inline">\(r\)</span>，这部分在下面的 position bias
会讨论）</p>
<p>如果让 ad 直接走推荐侧的模型，在物理意义上是 make sense
的，但可能会存在 2 个问题（1）ad 的特征未必能跟 item
的完全对齐（2）需要保证 <span class="math inline">\(u^a_i\)</span>&lt;<span class="math inline">\(u^o_i\)</span></p>
<p>对于这里的第二个问题，笔者有点疑惑，在Feeds流中，肯定会有一些广告商品本身的自然效率也是很高的，感觉没必要进行一个这样的现在，更应该考虑的是，如果广告品自身能竞得某个位置，加上revenue
utility可能会竞得一个更好的位置，那么如何根据这个改变来进行二价计费的修改，这个以后会介绍一些做法。</p>
<h3 id="position-bias">position bias</h3>
<p>这个问题在上面的 <span class="math inline">\(u^a_i\)</span> 、<span class="math inline">\(u^o_i\)</span> 和 <span class="math inline">\(r_i\)</span> 的获取讨论中提到了如果在计算 <span class="math inline">\(u^a_i\)</span> 、<span class="math inline">\(u^o_i\)</span> 和 <span class="math inline">\(r_i\)</span>不考虑位置信息，那必然是有偏的，因为不同位置的
ctr、cvr 等天然不一致</p>
<p>paper 里提到了一种方法，也是实际比较常用的：<strong>training
阶段使用实际的 position，serving 阶段使用统一的
position，同时保留一张映射表，映射不同位置跟 serving 时使用的统一位置的
discount，映射表可通过后验数据统计获取得到，最终预估值乘上这个 discount
就能等到不同位置的预估值</strong></p>
<p>这种做法的缺点是这张映射表需要经常更新，所以更好的做法是把这张表做到模型里，让模型训练过程中就能学到这个变化，预估阶段同时预估所有的位置的
score。</p>
<p>关于这个问题，笔者在工作中也做过一些尝试，并取得了不错的效果，后面有空可以介绍一下~</p>
<h3 id="gap-effect">gap effect</h3>
<p>对于推荐而言，往往序准确就可以了，但 a<strong>d
因为涉及到实际扣费，会要求 ctr，cvr
预估足够准确</strong>，才能避免扣费不准确，引起广告主的客诉等问题</p>
<p>除了上面的 position bias 会影响 ctr 准确性，两个 ad 之间的 gap
大小也会影响 ad 的 ctr 等，如下图所示，ad 的 gap 之间如果过小，ad
的点击率会过低，但 item 不会出现这种情况，本质上还是因为 ad
的密集度过高，即使前面提到了有min-gap 这一类硬规则</p>
<p><img src="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/Rerank_gap_effect.jpg" alt="img" style="zoom:33%;"></p>
<p>paper 提出的做法是给增加一个 gap 特征来捕捉这个信息，paper
做了如下推导，最终生效的形式跟 position_discount 有点像，等价于在原来的
ctr 基础上乘上一个 gap_discount, 下图中的 <span class="math inline">\(g\)</span> 是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Logit">Logit function</a>, <span class="math inline">\(y_{ij}\)</span> 表示是否发生点击（还可进一步把
<span class="math inline">\(β\)</span> 参数化，做成个性化的参数）</p>
<p><img src="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/Rerank_gap_effect_logit.jpg" alt="img" style="zoom:67%;"></p>
<p>而如果在上面的混排算法上加上 gap effect 的影响，会有如下的流程</p>
<p><img src="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/Rerank_gap_effect_algo.jpg" alt="img" style="zoom: 33%;"></p>
<h2 id="item-与-ad-价值度量的另一种思路">item 与 ad
价值度量的另一种思路</h2>
<p>paper 认为 item 价值是 engagement utility，ad 的价值是 engagement
utility + revenue utility</p>
<p>而上面也提到了获取 ad 的 engagement utility
会比较难，因此可以也可以考虑使用另一种思路来度量 item 和 ad 的价值</p>
<p>因为涉及到扣费，ad 的价值是比较好衡量的，一般采用的是 ecpm = bid ×
ctr ×
cvr（为了讨论方便，此处省略hidden_cost），因此很自然的一个想法是，<strong>能否为每个
item 也赋予一个 bid，这样也能在 item 侧算出一个类似 ecpm 的指标，与 ad
侧能进行比较</strong></p>
<p>紧接着的问题是，item 侧的 bid 的含义是什么？ad 侧的 bid
是有明确的物理含义的：广告主愿意为一个转化付的钱（还会叠加调价策略修改原始的广告主出价），但在
item 侧并没有广告主这一角色，由谁来出这个 bid 呢？</p>
<p>最直观的方法就是基于 ad 和 item 各自预估值的量级的差异，拍一个 item
侧的全局固定的 bid，但这样显然不是最优的，而且这个 bid
的量级也需要及时监控和更新，因为随着迭代，两边的预估值的 sacle
会发生变化</p>
<p>而如果从另一个角度来看，ad
更多是表达广告主的诉求，目标就是要更多的用户转化；item
更多是平台的诉求，
目标是要为平台带来更多的用户和留存时间；留存时间越长，也意味着可供平台变现的流量会更多，或者说<strong>用户指标其实也是跟平台长期收入挂钩的</strong>；因此可以基于大盘来测算用户指标与平台收入的关系，以
stay_duration 为例，可以对 stay_duration 分桶，测算 stay_duration
与平台长期收入指标的相关关系，建立一个函数 <span class="math inline">\(f\)</span>使得 <span class="math inline">\(bid=f(stayduration)\)</span>
当然这里的变量也不一定是 stay_duration，也可以是考虑 dislike、active
等各种信号，关键是要<strong>把用户在平台的留存、活跃等信息，与平台长期收入量化挂钩，然后基于这个收入倒推出一个
item 侧的 bid</strong></p>
<p>对于 ad 而言，如果与 item 混排时，把 ad 插在 items 的第 <span class="math inline">\(k\)</span>位带来的收益, 不仅仅是广告本身的
ecpm，还可进一步考虑由于广告插入给总体 items 带来的损失（VCG
计费的思想），即<strong>混排时 ad 的价值也可以考虑成“ad 带来收益 - item
后移的损失”</strong>；这样的话如果插入的位置导致 item
后移的损失较大，则总体的 ad 价值会下降，避免对 item 的挤压</p>
<h2 id="硬规则是否最优">硬规则是否最优</h2>
<p>上面提到了混排中存在着各种硬规则，比如说广告出现的首位，广告之间的min_gap，show_time
gap等，从技术角度来说，这样的离散的硬规则显然不是最优的，会极大限制算法的搜索空间；而从业务的角度，这种硬规则往往是业务发展初期拍定的，随着业务发展，对当前业务是否合理也是需要重新评估的</p>
<p>举个例子，一个对 ad 敏感和一个对 ad
不敏感的用户，使用同一套硬规则并不是最优的，因为同样的广告频率，在敏感用户那转化率会比较低，同时对用户的留存影响也会比较大（相对于不敏感的用户）；而如果给对
ad 不敏感的用户出更多的 ad，同时减少敏感用户的ad，打平总体的 ad
数，最终总体的 engagement utility 和 revenue utility
理论上也是更优的</p>
<p>具体的实现上，一般需要设置一套规则和计算方法，能够计算出硬规则中的所有可能情况下的
utility，然后加入到 list 的总体价值中</p>
<p>而这其实也涉及到推荐或广告系统里的优化的一个方向，就是个性化，一般大盘策略上对所有用户都相同的超参或策略，都会有个性化的空间</p>
<p>当然在这个过程也要注意个性化往往也会有个限制，以混排为例，需要对不敏感的用户有体验保护，不能逮住这部分用户一个劲地薅</p>
<h2 id="小结">小结</h2>
<p>本文从 LinkedIn 的一篇 paper
展开，介绍了混排需要解决的问题以及一种建模方法，paper
的建模不复杂，关键是建模中使用的各个 utility 的获取，paper
在这部分并没有说得比较详细，可能也是因为这部分跟实际业务耦合比较紧密；因此，本文后面也讨论了一种
item 和 ad 价值可能的计算方式：为 item 计算一个 bid， 同时考虑 ad 插入对
item 的影响</p>
<p>另外，paper 也提到了 position bias 、gap effect
等在混排中常见的问题，本文针对 paper
提出的方法和业界的一些做法做了讨论</p>
<p>最后，也探讨了一个比较比较开放的问题，就是混排中涉及到的 hard
rule，hard rule 一般是红线，但从技术视角来看肯定不是最优的，同时 hard
rule 是否合理，以及如何从业务角度和技术角度来 soften the hard rule，拿到
engagement utility 和 revenue utility
两部分的收益，也许是个值得讨论的问题</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://kerwinblog.top">mmmmlz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://kerwinblog.top/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/">http://kerwinblog.top/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Rec-System/">Rec System</a><a class="post-meta__tags" href="/tags/%E5%B9%BF%E5%91%8A/">广告</a></div><div class="post_share"><div class="social-share" data-image="/img/11.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/19/0319/" title="Position bias"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Position bias</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/02/0302/" title="U-Net in U-Net for Infrared Small Object Detection"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">U-Net in U-Net for Infrared Small Object Detection</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/05/23/0503/" title="Let’s think step by step"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-23</div><div class="title">Let’s think step by step</div></div></a></div><div><a href="/2023/03/19/0319/" title="Position bias"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-19</div><div class="title">Position bias</div></div></a></div><div><a href="/2023/01/14/0112/" title="Dynamic Knapsack Optimization Towards Efficient Multi-Channel Sequential Advertising"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-14</div><div class="title">Dynamic Knapsack Optimization Towards Efficient Multi-Channel Sequential Advertising</div></div></a></div><div><a href="/2022/12/04/20221204/" title="A Survey of Multi-Domain model"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-04</div><div class="title">A Survey of Multi-Domain model</div></div></a></div><div><a href="/2022/05/27/0527/" title="再看AUC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-27</div><div class="title">再看AUC</div></div></a></div><div><a href="/2022/04/05/ctrmodel/" title="CTR 预估模型简介--深度学习"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-05</div><div class="title">CTR 预估模型简介--深度学习</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/11.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mmmmlz</div><div class="author-info__description">great ideas in CV&RS</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mmmmlz"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Focus on the latest developments in recommendation algorithms, advertising algorithms, large models, etc.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E6%A8%A1%E6%96%B9%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text">建模方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E6%A8%A1%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98%E8%AE%A8%E8%AE%BA"><span class="toc-number">2.</span> <span class="toc-text">建模关键问题讨论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shadow-bid-%CE%B1-%E7%9A%84%E8%AE%A1%E7%AE%97"><span class="toc-number">2.1.</span> <span class="toc-text">shadow bid \(α\) 的计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uo_iua_i-%E5%92%8C-r_i%E7%9A%84%E8%AE%A1%E7%AE%97"><span class="toc-number">2.2.</span> <span class="toc-text">\(u^o_i\)、\(u^a_i\) 和 \(r_i\)的计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#position-bias"><span class="toc-number">2.3.</span> <span class="toc-text">position bias</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gap-effect"><span class="toc-number">2.4.</span> <span class="toc-text">gap effect</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#item-%E4%B8%8E-ad-%E4%BB%B7%E5%80%BC%E5%BA%A6%E9%87%8F%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%80%9D%E8%B7%AF"><span class="toc-number">3.</span> <span class="toc-text">item 与 ad
价值度量的另一种思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E8%A7%84%E5%88%99%E6%98%AF%E5%90%A6%E6%9C%80%E4%BC%98"><span class="toc-number">4.</span> <span class="toc-text">硬规则是否最优</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/23/0503/" title="Let’s think step by step">Let’s think step by step</a><time datetime="2023-05-22T19:11:02.000Z" title="Created 2023-05-23 03:11:02">2023-05-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/15/BidOptimization/" title="《Bid Optimization by Multivariable Control in Display Advertising》阅读笔记">《Bid Optimization by Multivariable Control in Display Advertising》阅读笔记</a><time datetime="2023-04-15T12:49:00.000Z" title="Created 2023-04-15 20:49:00">2023-04-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/19/0319/" title="Position bias">Position bias</a><time datetime="2023-03-18T19:11:02.000Z" title="Created 2023-03-19 03:11:02">2023-03-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/03/%E6%B7%B7%E6%8E%92%E6%8E%A2%E7%B4%A2/" title="混排到底该怎么排？">混排到底该怎么排？</a><time datetime="2023-03-03T13:56:49.000Z" title="Created 2023-03-03 21:56:49">2023-03-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/02/0302/" title="U-Net in U-Net for Infrared Small Object Detection">U-Net in U-Net for Infrared Small Object Detection</a><time datetime="2023-03-02T06:31:02.000Z" title="Created 2023-03-02 14:31:02">2023-03-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/7.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By mmmmlz</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script></div></body></html>